name: Test cache

on:
  pull_request:

defaults:
  run:
    shell: bash

jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      ver: ${{ steps.set_version.outputs.ver }}
    steps:
      - name: Set ver
        id: set_version
        run: |
          echo ::set-output name=ver::"v2.0.2"
  init:
    runs-on: ubuntu-latest
    needs: [ config ]
    steps:
      - name: Initialize
        run: |
          pip3 install --upgrade pip
          pip3 install west
          echo ${{needs.config.outputs.ver}}
          mkdir app && cd app
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${{needs.config.outputs.ver}}
          west update
      - name: Cache
        uses: actions/cache@v3
        id: cache-firmware
        with:
          path: app
          key: build-${{ github.sha }}-${{needs.config.outputs.ver}}
          restore-keys: |
            build-${{ github.sha }}-${{needs.config.outputs.ver}}
            
  build:
    runs-on: ubuntu-latest
    container: ghcr.io/zephyrproject-rtos/ci:v0.23.3
    env:
      ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.14.2
      CLANG_ROOT_DIR: /usr/lib/llvm-12
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr
    needs: [ config, init ]
    strategy:
        matrix:
          board-name: [nrf52840dk_nrf52840, nrf52dk_nrf52832]
    steps:
      - run: |
          wget https://github.com/facebook/zstd/archive/dev.zip
          unzip dev.zip
          cd zstd-dev
          make install
          zstd --version
      - name: Boot up
        uses: actions/cache@v3
        id: cache-firmware
        with:
          path: app
          key: build-${{ github.sha }}-${{needs.config.outputs.ver}}
      - name: Config
        run: |  
          cd app
          pip install --upgrade pip
          pip install -U west
          git config --global --add safe.directory bootloader
          git config --global --add safe.directory mbedtls
          git config --global --add safe.directory modules
          git config --global --add safe.directory nrf
          git config --global --add safe.directory nrfxlib
          git config --global --add safe.directory test
          git config --global --add safe.directory tools
          git config --global --add safe.directory zephyr
          west update
          pip3 install --user -r zephyr/scripts/requirements.txt
          pip3 install --user -r nrf/scripts/requirements.txt
          pip3 install --user -r bootloader/mcuboot/scripts/requirements.txt
          pip install -U ecdsa
          west zephyr-export
      - name: Build sample
        working-directory: app
        run: |
            cd nrf/samples/bluetooth/mesh/chat
            west build -b ${{ matrix.board-name }}
      - name: Cache build
        uses: actions/cache@v2
        id: cache-build
        with:
          path: nrf/samples/bluetooth/mesh/chat/build
          key: buildfw-${{ github.sha }}-${{ matrix.board-name }}
          restore-keys: |
            buildfw-${{ github.sha }}
      - name: Status 
        run: |
          FILESIZE=$(wc -c < nrf/samples/bluetooth/mesh/chat/build/zephyr/zephyr.bin)
          curl \
          -X POST \
          -H "Accept: application/vnd.github+json" \ 
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
          -d '{"state":"success","target_url":"https://example.com/build/status","description":"Firmware >> $FILESIZE","context":"robot/${{ matrix.board-name }}"}'
          
        
  store:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Restore build
        uses: actions/cache@v2
        id: cache-build
        with:
          path: builds
          key: buildfw-${{ github.sha }}
          
